@page "/auth/resetpassword"
@layout LoginLayout

<RadzenPanel Style="--rz-primary-light;width:fit-content;margin:auto">

    <RadzenStack JustifyContent="JustifyContent.Center"
                 AlignItems="AlignItems.Center"
                 Style="margin-bottom:10px">
        <RadzenImage Path="@UpdateImagePath()" Style="width:325px;height:325px" />
    </RadzenStack>

    <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
        <EditForm Model="_resetPasswordRequest" OnValidSubmit="ResetPasswordFunc">
            <DataAnnotationsValidator />
            <RadzenStack>
                <RadzenFormField Text="NewPassword">
                    <Start>
                        <RadzenIcon Icon="@GoogleIcons.Password" />
                    </Start>
                    <ChildContent>
                        <RadzenTextBox @ref="_txtFocus" 
                                       Style="width:300px" 
                                       AutoCompleteType="AutoCompleteType.Off"
                                       @bind-Value="@_resetPasswordRequest.NewPassword" />
                    </ChildContent>
                </RadzenFormField>
                <ValidationMessage For="(() => _resetPasswordRequest.NewPassword)" />

                <RadzenFormField>
                    <RadzenButton Style="width:300px"
                                  ButtonType="ButtonType.Submit"
                                  ButtonStyle="ButtonStyle.Primary">
                        @MyText.resetPassword
                    </RadzenButton>
                </RadzenFormField>
            </RadzenStack>
        </EditForm>
    </RadzenRow>

</RadzenPanel>

<Notification @ref="_notificationRef" />

@code {

    #region Injects

    [Inject]
    private IAuthenticationServiceFactory _authenticationService { get; set; }

    #endregion

    #region Parameters

    [SupplyParameterFromQuery]
    public string Email { get; set; }

    [SupplyParameterFromQuery]
    public string Code { get; set; }

    [CascadingParameter(Name = Strings.LoginLayoutTheme)]
    public string LoginTheme { get; set; }

    #endregion

    #region Variables

    private ResetPasswordRequest _resetPasswordRequest = new();

    private I18nText.MyText MyText = new I18nText.MyText();

    private string _imagePath { get; set; }

    private Notification _notificationRef;

    private RadzenTextBox _txtFocus;

    #endregion

    #region LifeCycleMethods

    protected override void OnParametersSet()
    {
        _resetPasswordRequest = new()
            {
                Code = Code,
                Email = Email
            };
    }

    protected override async Task OnInitializedAsync()
    {
        MyText = await I18nText.GetTextTableAsync<I18nText.MyText>(this);
    }

    #endregion

    #region Methods

    private string UpdateImagePath() => _imagePath = $"/images/resetpassword{GetThemeSuffix()}.png";

    private string GetThemeSuffix() => LoginTheme == Strings.DarkTheme ? "-dark" : string.Empty;

    private async Task ResetPasswordFunc()
    {
        var result = await _authenticationService.ResetPassword(_resetPasswordRequest);
        if (result.Success)
        {
            NavManager.NavigateTo("/");
            _resetPasswordRequest = new();
        }
        else
        {
            _notificationRef.ShowNotifications(MyText.failedToSendEmail, $"{result.ErrorResponse.Title}", NotificationSeverity.Error);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await _txtFocus.FocusAsync();
    }

    #endregion
}
