@page "/auth/forgetPassword"
@layout LoginLayout

<RadzenPanel Style="--rz-primary-light;width:fit-content;margin:auto">

    <RadzenStack JustifyContent="JustifyContent.Center"
                 AlignItems="AlignItems.Center"
                 Style="margin-bottom:10px">
        <RadzenImage Path="@UpdateImagePath()" Style="width:325px;height:325px" />
    </RadzenStack>

    <RadzenRow AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
        <EditForm Model="_forgetPasswordRequest" OnValidSubmit="ForgetPasswordFunc">
            <DataAnnotationsValidator />
            <RadzenStack>
                <RadzenFormField Text="Email">
                    <Start>
                        <RadzenIcon Icon="@GoogleIcons.Email" />
                    </Start>
                    <ChildContent>
                        <RadzenTextBox Style="width:300px"
                                       AutoCompleteType="AutoCompleteType.Off"
                                       @ref="_txtFocus"
                                       @bind-Value="@_forgetPasswordRequest.Email" />
                    </ChildContent>
                </RadzenFormField>
                <ValidationMessage For="(() => _forgetPasswordRequest.Email)" />

                <RadzenFormField>
                    <RadzenButton Style="width:300px"
                                  ButtonType="ButtonType.Submit"
                                  ButtonStyle="ButtonStyle.Primary">
                        @MyText.resetPassword
                    </RadzenButton>
                </RadzenFormField>
            </RadzenStack>
        </EditForm>
    </RadzenRow>

</RadzenPanel>

<Notification @ref="_notificationRef" />

@code {

    #region Cascading Parameter

    [CascadingParameter(Name = Strings.LoginLayoutTheme)]
    public string LoginTheme { get; set; }

    #endregion

    #region Injects

    [Inject]
    private IAuthenticationServiceFactory _authenticationService { get; set; }

    #endregion

    #region Variables

    private ForgorPasswordViewModel _forgetPasswordRequest = new();

    private string? _imagePath { get; set; }

    private Notification _notificationRef;

    private RadzenTextBox _txtFocus;

    private I18nText.MyText MyText = new();

    #endregion

    #region LifeCycleMethods

    protected override async Task OnInitializedAsync() => MyText = await I18nText.GetTextTableAsync<I18nText.MyText>(this);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await _txtFocus.FocusAsync();
    }

    #endregion

    #region Methods

    private string UpdateImagePath() => _imagePath = $"{Strings.ImagePath}{Strings.ForgetPasswordImage}{GetThemeSuffix()}.png";

    private string GetThemeSuffix() => LoginTheme == Strings.Dark ? "-dark" : string.Empty;

    private async Task ForgetPasswordFunc()
    {
        var result = await _authenticationService.ForgetPassword(_forgetPasswordRequest, InternalRoutes.ResetPassword);
        if (result.Success)
        {
            _notificationRef.ShowNotifications(MyText.emailSentSuccessfully, MyText.checkEmail, NotificationSeverity.Success);
            _forgetPasswordRequest = new();
        }
        else
        {
            _notificationRef.ShowNotifications(MyText.failedToSendEmail, $"{result.ErrorResponse.Title}", NotificationSeverity.Error);
        }
    }

    #endregion
}
