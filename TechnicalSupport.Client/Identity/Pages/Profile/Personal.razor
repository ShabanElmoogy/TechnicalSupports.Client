
<RadzenTemplateForm TItem="UserProfileViewModel" Method="Get" Data="User">
    <ChildContent>

        <RadzenRow>
            <RadzenColumn Size="9">
                <RadzenRow Style="margin-bottom:10px" AlignItems="AlignItems.Center">
                    <RadzenColumn Size="2">
                        <RadzenLabel Text="@MyText.username" style="width: 100%" />
                    </RadzenColumn>

                    <RadzenColumn Size="10">
                        <MyClearButton ClearTextBox="@ClearUserName" Visible="@(!IsEditMode)">
                            <TextBox>
                                <RadzenTextBox Name="@nameof(UserProfileViewModel.UserName)"
                                               @bind-Value="User.UserName"
                                               style="width: 100%"
                                               Disabled="!IsEditMode" />
                                <RadzenRequiredValidator Component="@nameof(UserProfileViewModel.UserName)" Text="@MyText.requiredField" />
                            </TextBox>
                        </MyClearButton>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow Style="margin-bottom:10px" AlignItems="AlignItems.Center">

                    <RadzenColumn Size="2">
                        <RadzenLabel Text="@MyText.firstName" style="width: 100%" />
                    </RadzenColumn>

                    <RadzenColumn Size="10">
                        <MyClearButton ClearTextBox="@ClearFirstName" Visible="@(!IsEditMode)">
                            <TextBox>
                                <RadzenTextBox Name="@nameof(UserProfileViewModel.FirstName)"
                                               @bind-Value="User.FirstName"
                                               style="width: 100%"
                                               Disabled="!IsEditMode" />

                                <RadzenRequiredValidator Component="@nameof(UserProfileViewModel.FirstName)" Text="@MyText.requiredField" />
                            </TextBox>
                        </MyClearButton>
                    </RadzenColumn>

                </RadzenRow>

                <RadzenRow Style="margin-bottom:10px" AlignItems="AlignItems.Center">

                    <RadzenColumn Size="2">
                        <RadzenLabel Text="@MyText.lastName"
                                     style="width: 100%" />
                    </RadzenColumn>

                    <RadzenColumn Size="10">
                        <MyClearButton ClearTextBox="@ClearLastName" Visible="@(!IsEditMode)">
                            <TextBox>
                                <RadzenTextBox Name="@nameof(UserProfileViewModel.LastName)"
                                               @bind-Value="User.LastName"
                                               style="width: 100%"
                                               Disabled="!IsEditMode" />

                                <RadzenRequiredValidator Component="@nameof(UserProfileViewModel.LastName)" Text="@MyText.requiredField" />
                            </TextBox>
                        </MyClearButton>
                    </RadzenColumn>

                </RadzenRow>

                <RadzenRow Style="margin-bottom:10px" AlignItems="AlignItems.Center">

                    <RadzenColumn Size="2">
                        <RadzenLabel Text="@MyText.userPhoto"
                                     style="width: 100%" />
                    </RadzenColumn>

                    <RadzenColumn Size="10">
                        <RadzenUpload Accept="image/*"
                                      Multiple="false"
                                      MaxFileCount="1"
                                      Change="HandleFileChange"
                                      Disabled="!IsEditMode"
                                      Style="width:100%" />
                    </RadzenColumn>

                </RadzenRow>
            </RadzenColumn>

            <RadzenColumn Size="3" Style="text-align:center">
                @if (!string.IsNullOrEmpty(_imgDataUrl))
                {
                    <img src="@_imgDataUrl" alt="Profile Picture" style="max-width: 200px; max-height: 350px;" />
                }
            </RadzenColumn>

        </RadzenRow>

        <RadzenRow Style="margin-bottom:10px">
            <RadzenColumn Size="9">
                <RadzenRow>
                    <RadzenColumn Size="10" Offset="2">
                        @if (IsEditMode)
                        {
                            <RadzenButton ButtonType="ButtonType.Submit"
                                          Icon="@GoogleIcons.Save"
                                          Text="@MyText.save"
                                          Click="UpdateInfo" />
                        }
                        else
                        {
                            <RadzenButton ButtonType="ButtonType.Button"
                                          Text="@MyText.edit"
                                          Icon="@GoogleIcons.Edit"
                                          Click="() => IsEditMode = true" />
                        }
                    </RadzenColumn>
                </RadzenRow>

            </RadzenColumn>
        </RadzenRow>
    </ChildContent>
</RadzenTemplateForm>

@implements IDisposable
@inject UserInfoService _userInfoService

@code {
    //TODO: Add Edit Picture

    private void ClearUserName() => User.UserName = string.Empty;

    private void ClearFirstName() => User.FirstName = string.Empty;

    private void ClearLastName() => User.FirstName = string.Empty;

    #region Parameters

    [CascadingParameter(Name = "UserProfilePhoto")]
    public byte[]? UserProfilePhoto { get; set; }

    [Parameter]
    public UserProfileViewModel? User { get; set; }

    [Parameter]
    public EventCallback<UserProfileViewModel> OnUserUpdated { get; set; }

    #endregion

    #region Injects

    [Inject]
    private IAccountService _accountService { get; set; }

    [Inject]
    private IFileService _fileService { get; set; }

    [Inject]
    private PhotoService _photoService { get; set; }

    #endregion

    #region Variables

    private I18nText.MyText MyText = new();

    private bool IsEditMode { get; set; } = false;

    private string? _imgDataUrl { get; set; }

    private IBrowserFile? _selectedFile;

    private byte[]? _userProfilePicture;

    private string? _userId;

    private bool IsPhotoUpdated = false;

    #endregion

    #region LifeCycleMethods

    protected async override Task OnInitializedAsync()
    {
        MyText = await I18nText.GetTextTableAsync<I18nText.MyText>(this);
        
        // Subscribe to photo updates
        _photoService.OnPhotoUpdated += UpdatePhotoDisplay;
        
        // Load photo from database
        _userId = await _userInfoService.GetUserIdAsync();
        await _photoService.LoadPhotoFromDatabaseAsync(_userId);
        
        // Load current photo from PhotoService
        var currentPhoto = _photoService.GetCurrentPhoto();
        if (currentPhoto?.Length > 0)
        {
            _imgDataUrl = $"data:image/*;base64,{Convert.ToBase64String(currentPhoto)}";
        }
    }

    protected override void OnParametersSet()
    {
        // Priority: User.ProfilePicture > PhotoService > UserProfilePhoto > default
        if (!string.IsNullOrEmpty(User?.ProfilePicture))
        {
            _imgDataUrl = $"data:image/*;base64,{User.ProfilePicture}";
        }
        else
        {
            var currentPhoto = _photoService?.GetCurrentPhoto();
            if (currentPhoto?.Length > 0)
            {
                _imgDataUrl = $"data:image/*;base64,{Convert.ToBase64String(currentPhoto)}";
            }
            else if (UserProfilePhoto is not null && UserProfilePhoto.Length > 0)
            {
                _imgDataUrl = $"data:image/*;base64,{Convert.ToBase64String(UserProfilePhoto)}";
            }
            else
            {
                _imgDataUrl = "/images/user.png";
            }
        }
    }

    
    #endregion

    #region Methods

    private async Task HandleFileChange(UploadChangeEventArgs args)
    {
        if (args.Files.Any())
        {
            var file = args.Files.FirstOrDefault();
            if (file != null)
            {
                _selectedFile = file;
                
                // Convert file to byte array and base64 for preview
                using var stream = new MemoryStream();
                await _selectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).CopyToAsync(stream);
                _userProfilePicture = stream.ToArray();
                
                // Update preview image
                _imgDataUrl = $"data:image/*;base64,{Convert.ToBase64String(_userProfilePicture)}";
                
                // Store the profile picture for upload
                // Note: UserProfileViewModel doesn't have ProfilePicture property
                
                IsPhotoUpdated = true;
            }
        }
        else
        {
            // File removed
            _imgDataUrl = "/images/user.png";
            _selectedFile = null;
            _userProfilePicture = null;
            IsPhotoUpdated = false;
        }

        StateHasChanged();
    }

    private void UpdatePhotoDisplay(byte[] photoData)
    {
        if (photoData?.Length > 0)
        {
            _imgDataUrl = $"data:image/*;base64,{Convert.ToBase64String(photoData)}";
        }
        else
        {
            _imgDataUrl = "/images/user.png";
        }
        StateHasChanged();
    }

    private async Task UpdateInfo()
    {
        // Include photo as base64 string if updated
        if (IsPhotoUpdated && _userProfilePicture != null)
        {
            User.ProfilePicture = Convert.ToBase64String(_userProfilePicture);
        }
        
        // Update user profile (including photo)
        await OnUserUpdated.InvokeAsync(User);
        
        // Update photo immediately in Personal component and notify other components
        if (IsPhotoUpdated && _userProfilePicture != null)
        {
            // Update local display immediately
            _imgDataUrl = $"data:image/*;base64,{Convert.ToBase64String(_userProfilePicture)}";
            
            // Reload photo from database to update PhotoService
            await _photoService.LoadPhotoFromDatabaseAsync(_userId);
            
            // Force UI update
            StateHasChanged();
        }
        
        IsEditMode = false;
        IsPhotoUpdated = false;
    }

    public void Dispose()
    {
        _photoService.OnPhotoUpdated -= UpdatePhotoDisplay;
    }


    #endregion
}
