@page "/companies-report"

<RadzenSplitter Orientation="Orientation.Vertical" style="height:calc(100vh - 120px); border: 1px solid rgba(0,0,0,.08);">
    <RadzenSplitterPane Size="100px">
        <RadzenSplitter>
            <RadzenSplitterPane Size="20%" Min="20%" Max="80%">
                <RadzenCard Style="height:100%; text-align:center; font-size:16px; font-weight:bold">
                    <div class="card-header">
                        <RadzenLabel Text="Companies Search" />
                    </div>
                    <EditForm Model="@_company" OnValidSubmit="@HandleSearch">
                        <MyClearButton ClearTextBox="@ClearTextBox">
                            <TextBox>
                                <RadzenTextBox Name="Name"
                                               Style="width: 100%;"
                                               MaxLength="50"
                                               @bind-Value="@_company.NameAr" />
                            </TextBox>
                        </MyClearButton>

                        <RadzenButton ButtonType="ButtonType.Submit"
                                      Text="Search"
                                      Style="width: 100%; margin-top: 10px;" />
                    </EditForm>
                </RadzenCard>
            </RadzenSplitterPane>
            <RadzenSplitterPane>
                <div style="flex: 1; height: 100%; margin: 0; padding: 0;">
                    <iframe id="reportFrame"
                            width="100%"
                            height="100%"
                            src="@_reportUrl"
                            style="border: none;">
                    </iframe>
                </div>
            </RadzenSplitterPane>
        </RadzenSplitter>
    </RadzenSplitterPane>
</RadzenSplitter>

@code {

    [Inject]
    public CultureService cultureService { get; set; }

    private string _appCulture { get; set; }

    public CompanyViewModel _company { get; set; } = new();

    private string _reportUrl { get; set; } = string.Empty;

    private I18nText.MyText MyText = new();

    private string _loaderText = string.Empty;

    protected override void OnInitialized()
    {
        cultureService.OnCultureChanged += OnCultureChanged;
        _appCulture = cultureService.GetCurrentCulture();
    }
    private void OnCultureChanged()
    {
        _appCulture = cultureService.GetCurrentCulture();
        HandleSearch();
    }

    private void HandleSearch()
    {
        _reportUrl = GenerateReportUrl(_company);
        StateHasChanged();
    }

    private string GenerateReportUrl(CompanyViewModel company)
    {
        var reportUri = Configuration.GetSection("ApiSettings:ReportApiAddress").Value;

        // Create the report request model
        var reportRequest = new ReportRequest
            {
                ReportPath = "Reports",
                ReportFileName = "Company",
                ExportFilename = "ExportedCompanies",
                LogoName = "Logo1.jpg",
                Lang = _appCulture,
                CompanyAr = company.NameAr
            };

        // Generate query string and return full report URL
        string queryString = GenerateQueryString(reportRequest);
        return $"{reportUri}report/generate?{queryString}";
    }

    private string GenerateQueryString(ReportRequest reportRequest)
    {
        // Serialize the report request properties into URL-encoded query string
        var queryString = new List<string>();

        if (!string.IsNullOrWhiteSpace(reportRequest.CompanyAr))
            queryString.Add($"CompanyAr={Uri.EscapeDataString(reportRequest.CompanyAr)}");

        if (!string.IsNullOrWhiteSpace(reportRequest.ReportPath))
            queryString.Add($"ReportPath={Uri.EscapeDataString(reportRequest.ReportPath)}");

        if (!string.IsNullOrWhiteSpace(reportRequest.ReportFileName))
            queryString.Add($"ReportFileName={Uri.EscapeDataString(reportRequest.ReportFileName)}");

        if (!string.IsNullOrWhiteSpace(reportRequest.ExportFilename))
            queryString.Add($"ExportFilename={Uri.EscapeDataString(reportRequest.ExportFilename)}");

        if (!string.IsNullOrWhiteSpace(reportRequest.LogoName))
            queryString.Add($"LogoName={Uri.EscapeDataString(reportRequest.LogoName)}");

        if (!string.IsNullOrWhiteSpace(reportRequest.Lang))
            queryString.Add($"Lang={Uri.EscapeDataString(reportRequest.Lang)}");

        return string.Join("&", queryString);
    }

    void ClearTextBox()
    {
        _company.NameAr = string.Empty;
        _reportUrl = GenerateReportUrl(new CompanyViewModel()); // Generate an empty or default report
    }

    public class ReportRequest
    {
        public string? ReportPath { get; set; }
        public string? ReportFileName { get; set; }
        public string? ExportFilename { get; set; }
        public string? LogoName { get; set; }
        public string? Lang { get; set; }
        public string? CompanyAr { get; set; }
    }
}