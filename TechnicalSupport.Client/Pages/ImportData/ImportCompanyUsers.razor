@page "/import-companyusers"

@inject ILocalStorageService localStorage
@inject DialogService dialogService

<h2>@MyText.uploadCompanyUsersData</h2>

<br />

<RadzenRow RowGap="0">
    <RadzenColumn Size="5">
        <NetcodeHubFileUpload @ref="FileUpload"
        Notify="RetrieveFiles"
        Multiple=false
        RequiredExtensions="RequiredEx"
        ShowDisplay="false" />
    </RadzenColumn>
    <RadzenColumn>
        <RadzenButton Text="@MyText.uploadData" Click="UploadCompanyUsers" Visible="@(_companyUsers.Count > 0)" />
    </RadzenColumn>
    <RadzenColumn Offset="2" Style="text-align:end">
        <RadzenButton Text="@MyText.deleteAllCompanyUsers" Click="DeleteAllCompanyUsers" />
    </RadzenColumn>
</RadzenRow>

<br />

@if (_customLoader)
{
    <MyLoader2 LoaderText="@_loaderText" />
}

@if (_showCounter)
{
    <h4>Time Spent: @ElapsedTime</h4>
}

<RadzenDataGrid Data="_companyUsers.Skip(0)">
    <Columns>
        <RadzenDataGridColumn Title="@MyText.companyUser" Property="@nameof(CompanyUsersViewModel.Name)" />
        <RadzenDataGridColumn Title="@MyText.anydesk" Property="@nameof(CompanyUsersViewModel.AnyDesk)" />
        <RadzenDataGridColumn Title="@MyText.anyDeskPassword" Property="@nameof(CompanyUsersViewModel.AnyDeskPassword)" />
        <RadzenDataGridColumn Title="@MyText.serverPassword" Property="@nameof(CompanyUsersViewModel.ServerPassword)" />
        <RadzenDataGridColumn Title="@MyText.companyId" Property="@nameof(CompanyUsersViewModel.CompanyId)" />
        <RadzenDataGridColumn Title="@MyText.cloudUser" Property="@nameof(CompanyUsersViewModel.CloudUser)" />
        <RadzenDataGridColumn Title="@MyText.cloudUserPassword" Property="@nameof(CompanyUsersViewModel.CloudUserPassword)" />
    </Columns>
</RadzenDataGrid>

<Notification @ref="NotificationRef" />

@code {
    [Inject]
    private IMainService<CompanyUsersViewModel>? _companyUsersService { get; set; }

    private Notification NotificationRef = new();

    private I18nText.MyText MyText = new();

    string Base64String = string.Empty;

    List<string> RequiredEx = [".xlsx"];

    private bool _customLoader;

    private bool _showCounter;

    private string _loaderText = string.Empty;

    private List<CompanyUsersViewModel> _companyUsers = new();

    NetcodeHubFileUpload FileUpload = new();

    private Stopwatch _stopwatch = new();

    private string ElapsedTime = "0s";

    protected override async Task OnInitializedAsync()
    {
        MyText = await I18nText.GetTextTableAsync<I18nText.MyText>(this);
    }

    private async Task RetrieveFiles(NetcodeHubUploadModel incomingFiles)
    {
        _customLoader = true;
        _loaderText = MyText.downloading;
        StateHasChanged();

        try
        {
            if (incomingFiles?.FileModel?.IBrowserFiles != null)
            {
                foreach (var item in incomingFiles.FileModel.IBrowserFiles)
                {
                    await ReadExcelFile(item);
                }
            }
        }
        catch (Exception ex)
        {
            NotificationRef.ShowNotifications("Error", $"Failed to read Excel file: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _customLoader = false;
            StateHasChanged();
        }
    }

    private async Task ReadExcelFile(IBrowserFile file)
    {
        const long maxFileSize = 10 * 1024 * 1024; // 10MB limit

        if (file.Size > maxFileSize)
        {
            NotificationRef.ShowNotifications("Error", "File size exceeds 10MB limit", NotificationSeverity.Error);
            return;
        }

        ExcelPackage.License.SetNonCommercialPersonal("shabanelmogy");
        _companyUsers.Clear();

        using (var stream = new MemoryStream())
        {
            await file.OpenReadStream(maxFileSize).CopyToAsync(stream);
            stream.Position = 0;

            using (var package = new ExcelPackage(stream))
            {
                if (package.Workbook.Worksheets.Count == 0)
                {
                    NotificationRef.ShowNotifications("Error", "No worksheets found in Excel file", NotificationSeverity.Error);
                    return;
                }

                var workSheet = package.Workbook.Worksheets[0];

                if (workSheet.Dimension == null)
                {
                    NotificationRef.ShowNotifications("Error", "Excel worksheet is empty", NotificationSeverity.Error);
                    return;
                }

                var rowCount = workSheet.Dimension.Rows;

                for (int row = 2; row <= rowCount; row++)
                {
                    var name = workSheet.Cells[row, 1].Text?.Trim();
                    var anydesk = workSheet.Cells[row, 2].Text?.Trim();
                    var anydeskPass = workSheet.Cells[row, 3].Text?.Trim();
                    var serverPass = workSheet.Cells[row, 4].Text?.Trim();
                    var companyIdText = workSheet.Cells[row, 5].Text;
                    var cloudUser = workSheet.Cells[row, 6].Text?.Trim();
                    var cloudUserPass = workSheet.Cells[row, 7].Text?.Trim();

                    if (string.IsNullOrEmpty(name) && string.IsNullOrEmpty(anydesk) && string.IsNullOrEmpty(anydeskPass) && string.IsNullOrEmpty(serverPass) && string.IsNullOrEmpty(companyIdText) && string.IsNullOrEmpty(cloudUser) && string.IsNullOrEmpty(cloudUserPass))
                        continue; // Skip completely empty rows

                    var companyUser = new CompanyUsersViewModel
                    {
                        Name = name ?? string.Empty,
                        AnyDesk = anydesk ?? string.Empty,
                        AnyDeskPassword = anydeskPass ?? string.Empty,
                        ServerPassword = serverPass ?? string.Empty,
                        CompanyId = int.TryParse(companyIdText, out int id) ? id : 0,
                        CloudUser = cloudUser ?? string.Empty,
                        CloudUserPassword = cloudUserPass ?? string.Empty
                    };

                    _companyUsers.Add(companyUser);
                }
            }
        }
    }

    private async Task UploadCompanyUsers()
    {
        try
        {
            _showCounter = true;
            _stopwatch.Restart();
            _stopwatch.Start();
            _customLoader = true;
            _loaderText = MyText.uploading;

            ElapsedTime = "0s";

            var timerTask = Task.Run(async () =>
            {
                while (_stopwatch.IsRunning)
                {
                    ElapsedTime = $"{_stopwatch.Elapsed.TotalSeconds:F0}s";
                    await InvokeAsync(StateHasChanged);
                    await Task.Delay(1000);
                }
            });

            var response = await _companyUsersService!.AddNewRows(_companyUsers, $"{ApiRoutes.v1}/{ApiRoutes.CompanyUsers.AddRangeCompanyUsers}");

            if (response.Success)
            {
                NotificationRef.ShowNotifications(MyText.companyUsersUpload, MyText.companyUsersDataUploaded, duration: 5000);
                _companyUsers.Clear();
                await localStorage.RemoveItemAsync(StorageKeys.CompaniesUsersGridSettings);
            }
            else
            {
                var error = response.ErrorResponse?.Errors.Values.SelectMany(list => list).ToList().FirstOrDefault()!;
                NotificationRef.ShowNotifications(MyText.companyUsersUpload, error, NotificationSeverity.Error, 10000);
            }
        }
        catch (Exception ex)
        {
            NotificationRef.ShowNotifications(MyText.companyUsersUpload, ex.Message, NotificationSeverity.Error, 10000);
        }
        finally
        {
            _stopwatch.Stop();
            _customLoader = false;
        }
    }

    private async Task DeleteAllCompanyUsers()
    {
        bool? confirmation = await dialogService.Confirm($"{MyText.confirmDelete} ?", MyText.deleteCompanyUsers);
        if (confirmation == true)
        {
            var response = await _companyUsersService!.DeleteRow($"{ApiRoutes.v1}/{ApiRoutes.CompanyUsers.DeleteAllCompanyUsers}");
            if (response.Success)
            {
                NotificationRef.ShowNotifications(MyText.compnayUsersDeleted, MyText.companyUsersDataDeleted);
                _companyUsers.Clear();
            }
            else
            {
                var error = response.ErrorResponse?.Errors.Values.SelectMany(list => list).ToList().FirstOrDefault()!;
                NotificationRef.ShowNotifications(MyText.error, error, NotificationSeverity.Error, 5000);
            }
        }
    }
}
