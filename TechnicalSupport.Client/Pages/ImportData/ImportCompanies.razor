@page "/import-companies"

<h2>@MyText.uploadCompaniesData</h2>

<br />

<RadzenRow RowGap="0">
    <RadzenColumn Size="5">
        <NetcodeHubFileUpload @ref="FileUpload"
                              Notify="RetrieveFiles"
                              Multiple=false
                              RequiredExtensions="RequiredEx"
                              ShowDisplay="false" />
    </RadzenColumn>
    <RadzenColumn>
        <RadzenButton Text="@MyText.uploadData" Click="UploadCompanies" Visible="@(_companies.Count > 0)" />
    </RadzenColumn>
    <RadzenColumn Offset="2" Style="text-align:end">
        <RadzenButton Text="@MyText.deleteAllCompanies" Click="DeleteAllCompanies" />
    </RadzenColumn>
</RadzenRow>

<br />

@if (_customLoader)
{
    <MyLoader2 LoaderText="@_loaderText" />
}

@if (_showCounter)
{
    <h4>Time Spent: @ElapsedTime</h4>
}

<RadzenDataGrid Data="_companies.Skip(0)">
    <Columns>
        <RadzenDataGridColumn Title="@MyText.companyNameAr" Property="@nameof(CompanyViewModel.NameAr)" />
        <RadzenDataGridColumn Title="@MyText.companyNameEn" Property="@nameof(CompanyViewModel.NameEn)" />
        <RadzenDataGridColumn Title="@MyText.serverAddressId" Property="@nameof(CompanyViewModel.ServerAddressId)" />
    </Columns>
</RadzenDataGrid>

<Notification @ref="NotificationRef" />

@code {
    [Inject]
    private IMainService<CompanyViewModel>? _companyService { get; set; }

    private Notification NotificationRef = new();

    private I18nText.MyText MyText = new();

    List<string> RequiredEx = [".xlsx"];

    private bool _customLoader;

    private bool _showCounter;

    private string _loaderText = string.Empty;

    private List<CompanyViewModel> _companies = new();

    NetcodeHubFileUpload FileUpload = new();

    private Stopwatch _stopwatch = new();

    private string ElapsedTime = "0s";

    protected override async Task OnInitializedAsync()
    {
        MyText = await I18nText.GetTextTableAsync<I18nText.MyText>(this);
    }

    private async Task RetrieveFiles(NetcodeHubUploadModel incomingFiles)
    {
        _customLoader = true;

        _loaderText = MyText.downloading;

        if (incomingFiles is not null)
        {
            foreach (var item in incomingFiles.FileModel!.IBrowserFiles!)
            {
                await ReadExcelFile(item);
            }
        }
        StateHasChanged();

        _customLoader = false;
    }

    private async Task ReadExcelFile(IBrowserFile file)
    {
        ExcelPackage.LicenseContext = LicenseContext.NonCommercial;
        _companies = new();

        using (var stream = new MemoryStream())
        {
            await file.OpenReadStream().CopyToAsync(stream);
            stream.Position = 0;

            using (var package = new ExcelPackage(stream))
            {
                var workSheet = package.Workbook.Worksheets[0];
                var rowCount = workSheet.Dimension.Rows;
                var colCount = workSheet.Dimension.Columns;

                // Assuming columns are labeled as "Id" and "NameAr"
                for (int row = 2; row <= rowCount; row++)
                {
                    var company = new CompanyViewModel();
                    company.NameAr = workSheet.Cells[row, 1].Text;
                    company.NameEn = workSheet.Cells[row, 2].Text;
                    company.ServerAddressId = int.TryParse(workSheet.Cells[row, 3].Text, out int id) ? id : 0;
                    _companies.Add(company);
                }
            }
        }
    }

    private async Task UploadCompanies()
    {
        try
        {
            // Start the stopwatch when upload starts
            _showCounter = true;
            _stopwatch.Restart();
            _stopwatch.Start();
            _customLoader = true;
            _loaderText = MyText.uploading;

            ElapsedTime = "0s"; // Reset time display

            // Update the time every second while the upload is in progress
            _ = Task.Run(() =>
            {
                while (_stopwatch.IsRunning)
                {
                    ElapsedTime = $"{_stopwatch.Elapsed.Seconds}s";
                    InvokeAsync(StateHasChanged); // Update UI
                    Task.Delay(1000).Wait();
                }
            });

            var response = await _companyService!.AddNewRows(_companies, $"{ApiRoutes.v1}/{ApiRoutes.Companies.AddCompanies}");

            if (response.Success)
            {
                NotificationRef.ShowNotifications(MyText.companiesUpload, MyText.companiesDataUploaded);
                _companies.Clear();
                await localStorage.RemoveItemAsync(StorageKeys.CompaniesGridSettings);
            }
            else
            {
                var error = response.ErrorResponse?.Errors.Values.SelectMany(list => list).ToList().FirstOrDefault()!;
                NotificationRef.ShowNotifications(MyText.companiesUpload, error, NotificationSeverity.Error, 10000);
            }
        }
        catch (Exception ex)
        {
            NotificationRef.ShowNotifications(MyText.companiesUpload, ex.Message, NotificationSeverity.Error, 10000);
        }
        finally
        {
            _stopwatch.Stop();
            _customLoader = false;
        }
    }

    private async Task DeleteAllCompanies()
    {
        bool? confirmation = await dialogService.Confirm($"{MyText.confirmDelete} {MyText.companies} ?", MyText.deleteCompanies);
        if (confirmation == true)
        {
            var response = await _companyService!.DeleteRow($"{ApiRoutes.v1}/{ApiRoutes.Companies.DeleteAllCompanies}");
            if (response.Success)
            {
                NotificationRef.ShowNotifications(MyText.companiesDeleted, MyText.companiesDataDeleted);
                _companies.Clear();
            }
            else
            {
                var error = response.ErrorResponse?.Errors.Values.SelectMany(list => list).ToList().FirstOrDefault()!;
                NotificationRef.ShowNotifications(MyText.error, error, NotificationSeverity.Error, 5000);
            }
        }
    }
}
