@page "/oraganize-tasks"

@inject DialogService DialogService
@inject UserInfoService _userInfoService

<RadzenScheduler @ref=@scheduler
                 style="height: 750px;"
                 TItem="AppointmentViewModel"
                 Data=@appointments
                 StartProperty="Start"
                 EndProperty="End"
                 TextProperty="Text"
                 SelectedIndex="2"
                 SlotRender=@OnSlotRender
                 SlotSelect=@OnSlotSelect
                 AppointmentSelect=@OnAppointmentSelect
                 AppointmentRender=@OnAppointmentRender
                 AppointmentMove=@OnAppointmentMove>

    <RadzenDayView />
    <RadzenWeekView />
    <RadzenMonthView />
    <RadzenYearView />

</RadzenScheduler>

<Notification @ref="NotificationRef" />

@code {

    [Inject]
    private IMainService<AppointmentViewModel> _appointmentService { get; set; }

    private RadzenScheduler<AppointmentViewModel> scheduler;

    private Notification NotificationRef;

    private Dictionary<DateTime, string> events = new Dictionary<DateTime, string>();

    IList<AppointmentViewModel> appointments = new List<AppointmentViewModel>();

    private string _userId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _userId = await _userInfoService.GetUserIdAsync();
        await LoadAppointments();
    }

    private async Task LoadAppointments()
    {
        try
        {
            var response = await _appointmentService.GetAll($"{ApiRoutes.v1}/{ApiRoutes.Appointments.GetAllAppointments}");

            if (response is not null)
            {
                appointments = response;
                await scheduler.Reload();
            }
            else
            {
                NotificationRef.ShowNotifications("error", "error");
            }
        }
        catch (Exception ex)
        {
            NotificationRef.ShowNotifications("error", "An error occurred while fetching appointments.");
        }
    }

    private void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        // Highlight today in month view
        if (args.View.Text == "Month" && args.Start.Date == DateTime.Today)
        {
            args.Attributes["style"] = "background: var(--rz-scheduler-highlight-background-color, rgba(255,220,40,.2));";
        }

        // Highlight working hours (9-18)
        if ((args.View.Text == "Week" || args.View.Text == "Day") && args.Start.Hour > 8 && args.Start.Hour < 19)
        {
            args.Attributes["style"] = "background: var(--rz-scheduler-highlight-background-color, rgba(255,220,40,.2));";
        }
    }

    private async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        if (args.View.Text != "Year")
        {
            AppointmentViewModel data = await DialogService.OpenAsync<AddAppointmentPage>("Add AppointmentViewModel",
                new Dictionary<string, object> { { "Start", args.Start }, { "End", args.End } });

            if (data != null)
            {
                appointments.Add(data);
                await scheduler.Reload();
                await SaveAppointment(data);
                await LoadAppointments();
            }
        }
    }

    private async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<AppointmentViewModel> args)
    {
        // Create a copy to pass to the dialog
        var dialogData = new AppointmentViewModel
            {
                Id = args.Data.Id,
                Start = args.Data.Start,
                End = args.Data.End,
                Text = args.Data.Text
            };

        // Open the EditAppointment dialog
        var data = await DialogService.OpenAsync<EditAppointmentPage>("Edit AppointmentViewModel", new Dictionary<string, object> { { "AppointmentViewModel", dialogData } });

        // If data contains the modified appointment
        if (data != null)
        {
            if (args.Data.Id > 0)
            {
                // Ensure the returned data has the correct ID
                data.Id = args.Data.Id;
                
                // Update existing appointment
                var response = await _appointmentService.UpdateRow(data, $"{ApiRoutes.v1}/{ApiRoutes.Appointments.EditAppointment}");
                if (response.Success)
                {
                    // Find and update the appointment in the local list
                    var existingAppointment = appointments.FirstOrDefault(a => a.Id == args.Data.Id);
                    if (existingAppointment != null)
                    {
                        existingAppointment.Start = data.Start;
                        existingAppointment.End = data.End;
                        existingAppointment.Text = data.Text;
                    }

                    await scheduler.Reload();
                    DialogService.Close(true);
                }
                else
                {
                    NotificationRef.ShowNotifications("error", "Error occurred while updating the appointment.");
                }
            }
            else
            {
                // This is a new appointment, save it first
                await SaveAppointment(data);
                // Remove the old appointment from local list
                appointments.Remove(args.Data);
                DialogService.Close(true);
            }
        }
    }

    private void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<AppointmentViewModel> args)
    {
        // Never call StateHasChanged in AppointmentRender - would lead to infinite loop

        if (args.Data.Text == "Birthday")
        {
            args.Attributes["style"] = "background: red";
        }
    }

    private async Task OnAppointmentMove(SchedulerAppointmentMoveEventArgs args)
    {
        var draggedAppointment = appointments.FirstOrDefault(x => x == args.Appointment.Data);

        if (draggedAppointment != null)
        {
            // Store original times for rollback
            var originalStart = draggedAppointment.Start;
            var originalEnd = draggedAppointment.End;

            // Update the appointment times
            draggedAppointment.Start += args.TimeSpan;
            draggedAppointment.End += args.TimeSpan;

            try
            {
                if (draggedAppointment.Id > 0)
                {
                    // Send the updated appointment to the backend
                    var response = await _appointmentService.UpdateRow(draggedAppointment, $"{ApiRoutes.v1}/{ApiRoutes.Appointments.EditAppointment}");

                    if (response.Success)
                    {
                        // Reload the scheduler to reflect changes
                        await scheduler.Reload();
                    }
                    else
                    {
                        // Revert the changes if update failed
                        draggedAppointment.Start = originalStart;
                        draggedAppointment.End = originalEnd;
                        await scheduler.Reload();
                        NotificationRef.ShowNotifications("error", "Failed to update appointment position.");
                    }
                }
                else
                {
                    // This is a new appointment, just update locally
                    await scheduler.Reload();
                }
            }
            catch (Exception ex)
            {
                // Revert the changes if update failed
                draggedAppointment.Start = originalStart;
                draggedAppointment.End = originalEnd;
                await scheduler.Reload();
                NotificationRef.ShowNotifications("error", "An error occurred while processing the appointment move.");
            }
        }
    }

    private async Task SaveAppointment(AppointmentViewModel appointment)
    {
        try
        {
            var response = await _appointmentService.AddNewRow(appointment, $"{ApiRoutes.v1}/{ApiRoutes.Appointments.AddAppointment}");
            if (response.Success)
            {
                appointments.Add(appointment);
                await scheduler.Reload();
                DialogService.Close(true);
            }
            else
            {
                NotificationRef.ShowNotifications("error", "error");
            }
        }
        catch (Exception ex)
        {

        }
    }
}
